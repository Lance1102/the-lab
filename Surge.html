<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNS 14676-5 突波測試互動指南</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
        }
        .card {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }
        .btn {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #4b5563;
        }
        .btn-secondary:hover {
            background-color: #374151;
        }
        .btn-active {
            background-color: #1d4ed8;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .label-group input:checked + label {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
        }
        .label-group label {
            border: 1px solid #4b5563;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">CNS 14676-5 / IEC 61000-4-5</h1>
            <h2 class="text-xl md:text-2xl font-semibold text-blue-400">組合波雷擊測試互動指南</h2>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- 波形視覺化 -->
            <div class="card lg:col-span-2">
                <h3 class="text-xl font-bold mb-4 text-white flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-400"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                    波形視覺化
                </h3>
                <div class="bg-gray-900 p-4 rounded-lg">
                    <canvas id="waveformCanvas"></canvas>
                </div>
                <div class="mt-4 flex justify-center space-x-4">
                    <button id="drawVoltageBtn" class="btn btn-active">1.2/50 µs 開路電壓波</button>
                    <button id="drawCurrentBtn" class="btn btn-secondary">8/20 µs 短路電流波</button>
                </div>
                 <div id="waveformInfo" class="mt-4 text-center text-gray-400 h-10"></div>
            </div>

            <!-- 測試等級 -->
            <div class="card">
                <h3 class="text-xl font-bold mb-4 text-white flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-400"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>
                    測試等級
                </h3>
                <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 text-center">
                    <button class="level-btn p-2 border border-gray-600 rounded-lg hover:bg-blue-600 transition" data-level="1" data-voltage="500">等級 1</button>
                    <button class="level-btn p-2 border border-gray-600 rounded-lg hover:bg-blue-600 transition" data-level="2" data-voltage="1000">等級 2</button>
                    <button class="level-btn p-2 border border-gray-600 rounded-lg hover:bg-blue-600 transition" data-level="3" data-voltage="2000">等級 3</button>
                    <button class="level-btn p-2 border border-gray-600 rounded-lg hover:bg-blue-600 transition" data-level="4" data-voltage="4000">等級 4</button>
                    <button class="level-btn p-2 border border-gray-600 rounded-lg hover:bg-blue-600 transition" data-level="X" data-voltage="custom">等級 X</button>
                </div>
                <div class="mt-6 p-4 bg-gray-900 rounded-lg text-center">
                    <p class="text-gray-400">開路測試電壓 (Uoc)</p>
                    <p id="voltageDisplay" class="text-3xl font-bold text-blue-400">500 V</p>
                    <p class="text-gray-400 mt-4">2Ω 源阻抗下之最大峰值電流 (Isc)</p>
                    <p id="currentDisplay" class="text-3xl font-bold text-green-400">250 A</p>
                </div>
            </div>

            <!-- 2Ω 源阻抗 -->
            <div class="card">
                 <h3 class="text-xl font-bold mb-4 text-white flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-400"><path d="M14 9.5L16.5 12L14 14.5"></path><path d="M9.5 14.5L7 12L9.5 9.5"></path><path d="M2 12h5"></path><path d="M17 12h5"></path><path d="M7 7l10 10"></path><path d="M7 17l10-10"></path></svg>
                    2Ω 有效源阻抗之謎
                </h3>
                <div class="flex flex-col items-center">
                    <div id="circuit-diagram" class="relative w-full max-w-sm h-32 mb-4">
                        <!-- Circuit elements will be dynamically created here -->
                    </div>
                    <p class="text-center text-gray-300">產生器如同一個帶有 2Ω 內阻的電壓源。實際電流取決於待測物(EUT)的阻抗。</p>
                    <div class="mt-4 p-4 bg-gray-900 rounded-lg w-full">
                        <p class="text-center font-mono text-lg text-yellow-300">Isc = Uoc / 2Ω</p>
                    </div>
                </div>
            </div>

            <!-- 測試程序時間估算 -->
            <div class="card lg:col-span-2">
                <h3 class="text-xl font-bold mb-4 text-white flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-400"><path d="M8 3v3a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V3"></path><path d="M21 8h-3a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h3"></path><path d="M3 8h3a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H3"></path><path d="M12 18v3a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-3"></path><path d="M12 3v18"></path></svg>
                    測試程序時間估算
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="testProcedureForm">
                    <div>
                        <p class="font-semibold mb-2">1. 耦合路徑 (Coupling Path)</p>
                        <div class="flex flex-col space-y-2 label-group">
                             <div class="flex items-center"><input type="checkbox" id="path_l_pe" class="hidden proc-input"><label for="path_l_pe">線對地 (L-PE)</label></div>
                             <div class="flex items-center"><input type="checkbox" id="path_n_pe" class="hidden proc-input"><label for="path_n_pe">線對地 (N-PE)</label></div>
                             <div class="flex items-center"><input type="checkbox" id="path_l_n" class="hidden proc-input"><label for="path_l_n">線對線 (L-N)</label></div>
                        </div>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">2. 極性 (Polarity)</p>
                        <div class="flex flex-col space-y-2 label-group">
                             <div class="flex items-center"><input type="checkbox" id="pol_pos" class="hidden proc-input"><label for="pol_pos">正極性 (+)</label></div>
                             <div class="flex items-center"><input type="checkbox" id="pol_neg" class="hidden proc-input"><label for="pol_neg">負極性 (-)</label></div>
                        </div>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">3. 相位角 (Phase Angle)</p>
                         <div class="flex flex-col space-y-2 label-group">
                             <div class="flex items-center"><input type="checkbox" id="phase_0" class="hidden proc-input"><label for="phase_0">0°</label></div>
                             <div class="flex items-center"><input type="checkbox" id="phase_90" class="hidden proc-input"><label for="phase_90">90°</label></div>
                             <div class="flex items-center"><input type="checkbox" id="phase_180" class="hidden proc-input"><label for="phase_180">180°</label></div>
                             <div class="flex items-center"><input type="checkbox" id="phase_270" class="hidden proc-input"><label for="phase_270">270°</label></div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-gray-900 rounded-lg text-center flex flex-col md:flex-row justify-around items-center">
                    <div>
                        <p class="text-gray-400">總脈衝次數 (5次/條件)</p>
                        <p id="pulseCount" class="text-3xl font-bold text-blue-400">0</p>
                    </div>
                    <div class="mt-4 md:mt-0">
                        <p class="text-gray-400">最短測試時間 (1次/分鐘)</p>
                        <p id="testTime" class="text-3xl font-bold text-green-400">0 分鐘</p>
                    </div>
                </div>
            </div>

            <!-- 性能準則 -->
            <div class="card lg:col-span-2">
                <h3 class="text-xl font-bold mb-4 text-white flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-400"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                    性能準則 (Performance Criteria)
                </h3>
                <div class="space-y-4">
                    <div class="p-4 bg-gray-800 rounded-lg border-l-4 border-green-500">
                        <h4 class="font-bold text-lg text-green-400">準則 A: 正常性能</h4>
                        <p class="text-gray-300">測試期間及之後，EUT 功能完全正常，無任何性能劣化。</p>
                    </div>
                    <div class="p-4 bg-gray-800 rounded-lg border-l-4 border-yellow-500">
                        <h4 class="font-bold text-lg text-yellow-400">準則 B: 暫時性能劣化，可自我恢復</h4>
                        <p class="text-gray-300">測試時出現暫時性能劣化，干擾停止後能自動恢復正常。</p>
                    </div>
                    <div class="p-4 bg-gray-800 rounded-lg border-l-4 border-orange-500">
                        <h4 class="font-bold text-lg text-orange-400">準則 C: 暫時性能劣化，需操作員介入</h4>
                        <p class="text-gray-300">功能喪失，需手動介入 (如重開機) 才能恢復正常。</p>
                    </div>
                    <div class="p-4 bg-gray-800 rounded-lg border-l-4 border-red-500">
                        <h4 class="font-bold text-lg text-red-400">準則 D: 不可恢復的損壞</h4>
                        <p class="text-gray-300">發生永久性的硬體/軟體損壞或資料遺失，無法恢復。</p>
                    </div>
                </div>
            </div>

        </div>
         <footer class="text-center mt-10 text-gray-500 text-sm">
            <p>基於 CNS 14676-5 / IEC 61000-4-5 標準建立的互動式指南。</p>
            <p>僅供教學與示意用途。</p>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Waveform Canvas ---
        const canvas = document.getElementById('waveformCanvas');
        const ctx = canvas.getContext('2d');
        const drawVoltageBtn = document.getElementById('drawVoltageBtn');
        const drawCurrentBtn = document.getElementById('drawCurrentBtn');
        const waveformInfo = document.getElementById('waveformInfo');

        let currentWaveform = 'voltage';

        function resizeCanvas() {
            const container = canvas.parentElement;
            const dpr = window.devicePixelRatio || 1;
            canvas.width = container.clientWidth * dpr;
            canvas.height = container.clientWidth * 0.5 * dpr;
            canvas.style.width = `${container.clientWidth}px`;
            canvas.style.height = `${container.clientWidth * 0.5}px`;
            ctx.scale(dpr, dpr);
            drawWaveform();
        }

        function drawGrid() {
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;
            ctx.clearRect(0, 0, width, height);

            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1;
            
            // Draw grid lines
            for (let i = 1; i < 10; i++) {
                // Vertical
                ctx.beginPath();
                ctx.moveTo(i * width / 10, 0);
                ctx.lineTo(i * width / 10, height);
                ctx.stroke();
                // Horizontal
                ctx.beginPath();
                ctx.moveTo(0, i * height / 10);
                ctx.lineTo(width, i * height / 10);
                ctx.stroke();
            }

            // Draw axes
            ctx.strokeStyle = '#6b7280';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, height * 0.9);
            ctx.lineTo(width, height * 0.9);
            ctx.moveTo(width * 0.05, 0);
            ctx.lineTo(width * 0.05, height);
            ctx.stroke();
            
            // Axes Labels
            ctx.fillStyle = '#9ca3af';
            ctx.font = '12px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('時間 (µs)', width / 2, height * 0.95);
            ctx.save();
            ctx.translate(width * 0.02, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('振幅 (%)', 0, 0);
            ctx.restore();
        }

        function drawWaveform() {
            drawGrid();
            if (currentWaveform === 'voltage') {
                drawVoltageWave();
            } else {
                drawCurrentWave();
            }
        }
        
        function getVoltagePoint(t) {
            // Approximation of 1.2/50us waveform using double exponential
            const tau1 = 0.40; // fast rise
            const tau2 = 68.22; // slow decay
            const k = 1.037; // normalization factor
            return k * (Math.exp(-t / tau2) - Math.exp(-t / tau1));
        }
        
        function getCurrentPoint(t) {
            // Approximation of 8/20us waveform using double exponential
             const tau1 = 4.0; 
             const tau2 = 28.0;
             const k = 1.2;
             return k * (Math.exp(-t / tau2) - Math.exp(-t / tau1));
        }

        function drawVoltageWave() {
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;
            const xOffset = width * 0.05;
            const yOffset = height * 0.9;
            const xScale = width * 0.9 / 100; // 100us total time
            const yScale = height * 0.8;

            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            let peakTime = 0, peakValue = 0;
            let time50 = 0;

            for (let t = 0; t < 100; t += 0.5) {
                const y = getVoltagePoint(t);
                if (y > peakValue) {
                    peakValue = y;
                    peakTime = t;
                }
                const xPos = xOffset + t * xScale;
                const yPos = yOffset - y * yScale;
                if (t === 0) {
                    ctx.moveTo(xPos, yOffset);
                } else {
                    ctx.lineTo(xPos, yPos);
                }
            }
            ctx.stroke();
            
            for(let t = peakTime; t < 100; t += 0.1) {
                if (getVoltagePoint(t) <= peakValue * 0.5) {
                    time50 = t;
                    break;
                }
            }

            // Annotations
            ctx.fillStyle = '#60a5fa';
            ctx.font = '12px Inter';
            ctx.textAlign = 'left';
            // Peak
            ctx.beginPath();
            ctx.arc(xOffset + peakTime * xScale, yOffset - peakValue * yScale, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.fillText(`T_front ≈ 1.2µs`, xOffset + peakTime * xScale + 10, yOffset - peakValue * yScale - 20);
            // 50% decay
            ctx.beginPath();
            ctx.arc(xOffset + time50 * xScale, yOffset - (peakValue * 0.5) * yScale, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.fillText(`T_duration ≈ 50µs`, xOffset + time50 * xScale + 10, yOffset - (peakValue * 0.5) * yScale);
            
            waveformInfo.textContent = '波前時間 (Front Time): 1.2 µs (±30%) | 持續時間 (Duration): 50 µs (±20%)';
        }

        function drawCurrentWave() {
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;
            const xOffset = width * 0.05;
            const yOffset = height * 0.9;
            const xScale = width * 0.9 / 40; // 40us total time
            const yScale = height * 0.8;

            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 3;
            ctx.beginPath();

            let peakTime = 0, peakValue = 0;
            let time50 = 0;
            
            for (let t = 0; t < 40; t += 0.2) {
                const y = getCurrentPoint(t);
                 if (y > peakValue) {
                    peakValue = y;
                    peakTime = t;
                }
                const xPos = xOffset + t * xScale;
                const yPos = yOffset - y * yScale;
                if (t === 0) {
                    ctx.moveTo(xPos, yOffset);
                } else {
                    ctx.lineTo(xPos, yPos);
                }
            }
            ctx.stroke();

            for(let t = peakTime; t < 40; t += 0.1) {
                if (getCurrentPoint(t) <= peakValue * 0.5) {
                    time50 = t;
                    break;
                }
            }
            
            // Annotations
            ctx.fillStyle = '#34d399';
            ctx.font = '12px Inter';
             // Peak
            ctx.beginPath();
            ctx.arc(xOffset + peakTime * xScale, yOffset - peakValue * yScale, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.fillText(`T_front ≈ 8µs`, xOffset + peakTime * xScale + 10, yOffset - peakValue * yScale - 20);
            // 50% decay
            ctx.beginPath();
            ctx.arc(xOffset + time50 * xScale, yOffset - (peakValue * 0.5) * yScale, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.fillText(`T_duration ≈ 20µs`, xOffset + time50 * xScale + 10, yOffset - (peakValue * 0.5) * yScale);

            waveformInfo.textContent = '波前時間 (Front Time): 8 µs (±20%) | 持續時間 (Duration): 20 µs (±20%)';
        }


        drawVoltageBtn.addEventListener('click', () => {
            currentWaveform = 'voltage';
            drawVoltageBtn.classList.add('btn-active');
            drawVoltageBtn.classList.remove('btn-secondary');
            drawCurrentBtn.classList.remove('btn-active');
            drawCurrentBtn.classList.add('btn-secondary');
            drawWaveform();
        });

        drawCurrentBtn.addEventListener('click', () => {
            currentWaveform = 'current';
            drawCurrentBtn.classList.add('btn-active');
            drawCurrentBtn.classList.remove('btn-secondary');
            drawVoltageBtn.classList.remove('btn-active');
            drawVoltageBtn.classList.add('btn-secondary');
            drawWaveform();
        });

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- Test Levels ---
        const levelButtons = document.querySelectorAll('.level-btn');
        const voltageDisplay = document.getElementById('voltageDisplay');
        const currentDisplay = document.getElementById('currentDisplay');

        levelButtons.forEach(button => {
            button.addEventListener('click', () => {
                const voltage = button.dataset.voltage;
                if (voltage === 'custom') {
                    voltageDisplay.textContent = '特殊';
                    currentDisplay.textContent = '特殊';
                } else {
                    const v = parseInt(voltage);
                    voltageDisplay.textContent = `${v} V`;
                    currentDisplay.textContent = `${v / 2} A`;
                }
                 levelButtons.forEach(btn => btn.classList.remove('bg-blue-600'));
                 button.classList.add('bg-blue-600');
            });
        });
        // Set initial active state
        document.querySelector('.level-btn[data-level="1"]').classList.add('bg-blue-600');

        // --- Circuit Diagram ---
        const circuitContainer = document.getElementById('circuit-diagram');
        circuitContainer.innerHTML = `
            <svg viewBox="0 0 300 100" class="w-full h-full">
                <!-- Generator -->
                <circle cx="50" cy="50" r="20" stroke="#9ca3af" stroke-width="2" fill="none"/>
                <text x="50" y="55" font-size="12" fill="#9ca3af" text-anchor="middle">CWG</text>
                <text x="50" y="30" font-size="10" fill="#e5e7eb" text-anchor="middle" id="circuit-voltage">0.5 kV</text>
                <!-- Wires -->
                <line x1="0" y1="50" x2="30" y2="50" stroke="#9ca3af" stroke-width="2"/>
                <line x1="70" y1="50" x2="100" y2="50" stroke="#9ca3af" stroke-width="2"/>
                <line x1="160" y1="50" x2="210" y2="50" stroke="#9ca3af" stroke-width="2"/>
                <line x1="270" y1="50" x2="300" y2="50" stroke="#9ca3af" stroke-width="2"/>
                 <line x1="0" y1="80" x2="300" y2="80" stroke="#9ca3af" stroke-width="2"/>
                <line x1="30" y1="50" x2="30" y2="80" stroke="#9ca3af" stroke-width="2"/>
                 <line x1="270" y1="50" x2="270" y2="80" stroke="#9ca3af" stroke-width="2"/>
                
                <!-- Resistor -->
                <rect x="100" y="45" width="60" height="10" stroke="#9ca3af" stroke-width="2" fill="#1f2937"/>
                <text x="130" y="40" font-size="10" fill="#e5e7eb" text-anchor="middle">2 Ω</text>
                <text x="130" y="25" font-size="10" fill="#9ca3af" text-anchor="middle">Source Impedance</text>

                <!-- EUT -->
                <rect x="210" y="30" width="60" height="40" stroke="#9ca3af" stroke-width="2" fill="#111827"/>
                <text x="240" y="55" font-size="12" fill="#9ca3af" text-anchor="middle">EUT</text>
            </svg>
        `;

        // --- Test Procedure Calculator ---
        const procInputs = document.querySelectorAll('.proc-input');
        const pulseCountDisplay = document.getElementById('pulseCount');
        const testTimeDisplay = document.getElementById('testTime');

        function calculateTestTime() {
            const paths = document.querySelectorAll('#testProcedureForm input[type="checkbox"][id^="path_"]:checked').length;
            const polarities = document.querySelectorAll('#testProcedureForm input[type="checkbox"][id^="pol_"]:checked').length;
            const phases = document.querySelectorAll('#testProcedureForm input[type="checkbox"][id^="phase_"]:checked').length;

            const pulsesPerCondition = 5;
            const totalConditions = paths * polarities * phases;
            const totalPulses = totalConditions * pulsesPerCondition;
            const totalTime = totalPulses; // 1 pulse per minute

            pulseCountDisplay.textContent = totalPulses;
            testTimeDisplay.textContent = `${totalTime} 分鐘`;
        }

        procInputs.forEach(input => {
            input.addEventListener('change', calculateTestTime);
        });

        calculateTestTime();
    });
    </script>
</body>
</html>
